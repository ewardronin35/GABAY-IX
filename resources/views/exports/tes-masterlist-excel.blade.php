<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

<table>
    <tr>
        <td colspan="26" style="text-align: center; font-size: 10px; font-family: Arial, sans-serif;">Republic of the Philippines</td>
    </tr>
    <tr>
        <td colspan="26" style="text-align: center; font-size: 12px; font-weight: bold; font-family: Arial, sans-serif;">COMMISSION ON HIGHER EDUCATION</td>
    </tr>
    <tr>
        <td colspan="26" style="text-align: center; font-size: 11px; font-weight: bold; font-family: Arial, sans-serif;">REGIONAL OFFICE IX</td>
    </tr>
    <tr>
        <td colspan="26" style="text-align: center; font-size: 16px; font-weight: bold; color: #0056b3; font-family: Arial, sans-serif; height: 30px; vertical-align: middle;">TERTIARY EDUCATION SUBSIDY (TES) MASTERLIST</td>
    </tr>
    <tr>
        <td colspan="26" style="text-align: center; font-size: 10px; font-style: italic; font-family: Arial, sans-serif;">Generated on: {{ date('F d, Y h:i A') }}</td>
    </tr>
    <tr><td colspan="26"></td></tr> {{-- Spacer Row --}}

    <thead>
        <tr style="height: 35px;">
            {{-- 1. SEQ --}}
            <th style="background-color: #0056b3; color: #ffffff; font-weight: bold; text-align: center; border: 1px solid #000000; vertical-align: middle; width: 8px;">SEQ</th>
            
            {{-- 2-7. LOCATION --}}
            <th style="background-color: #0056b3; color: #ffffff; font-weight: bold; text-align: center; border: 1px solid #000000; vertical-align: middle; width: 20px;">REGION</th>
            <th style="background-color: #0056b3; color: #ffffff; font-weight: bold; text-align: center; border: 1px solid #000000; vertical-align: middle; width: 20px;">PROVINCE</th>
            <th style="background-color: #0056b3; color: #ffffff; font-weight: bold; text-align: center; border: 1px solid #000000; vertical-align: middle; width: 20px;">CITY/MUNICIPALITY</th>
            <th style="background-color: #0056b3; color: #ffffff; font-weight: bold; text-align: center; border: 1px solid #000000; vertical-align: middle; width: 15px;">DISTRICT</th>
            <th style="background-color: #0056b3; color: #ffffff; font-weight: bold; text-align: center; border: 1px solid #000000; vertical-align: middle; width: 20px;">BARANGAY</th>
            <th style="background-color: #0056b3; color: #ffffff; font-weight: bold; text-align: center; border: 1px solid #000000; vertical-align: middle; width: 10px;">ZIP CODE</th>
            
            {{-- 8-9. HEI INFO --}}
            <th style="background-color: #0056b3; color: #ffffff; font-weight: bold; text-align: center; border: 1px solid #000000; vertical-align: middle; width: 40px;">HEI NAME</th>
            <th style="background-color: #0056b3; color: #ffffff; font-weight: bold; text-align: center; border: 1px solid #000000; vertical-align: middle; width: 15px;">HEI TYPE</th>
            
            {{-- 10-11. IDS --}}
            <th style="background-color: #0056b3; color: #ffffff; font-weight: bold; text-align: center; border: 1px solid #000000; vertical-align: middle; width: 25px;">AWARD NO.</th>
            <th style="background-color: #0056b3; color: #ffffff; font-weight: bold; text-align: center; border: 1px solid #000000; vertical-align: middle; width: 20px;">APP NO.</th>
            
            {{-- 12-17. PERSONAL INFO --}}
            <th style="background-color: #0056b3; color: #ffffff; font-weight: bold; text-align: center; border: 1px solid #000000; vertical-align: middle; width: 20px;">LAST NAME</th>
            <th style="background-color: #0056b3; color: #ffffff; font-weight: bold; text-align: center; border: 1px solid #000000; vertical-align: middle; width: 20px;">FIRST NAME</th>
            <th style="background-color: #0056b3; color: #ffffff; font-weight: bold; text-align: center; border: 1px solid #000000; vertical-align: middle; width: 10px;">EXT</th>
            <th style="background-color: #0056b3; color: #ffffff; font-weight: bold; text-align: center; border: 1px solid #000000; vertical-align: middle; width: 20px;">MIDDLE NAME</th>
            <th style="background-color: #0056b3; color: #ffffff; font-weight: bold; text-align: center; border: 1px solid #000000; vertical-align: middle; width: 8px;">SEX</th>
            <th style="background-color: #0056b3; color: #ffffff; font-weight: bold; text-align: center; border: 1px solid #000000; vertical-align: middle; width: 15px;">CONTACT NO.</th>
            
            {{-- 18-21. ACADEMIC --}}
            <th style="background-color: #0056b3; color: #ffffff; font-weight: bold; text-align: center; border: 1px solid #000000; vertical-align: middle; width: 30px;">COURSE/PROGRAM</th>
            <th style="background-color: #0056b3; color: #ffffff; font-weight: bold; text-align: center; border: 1px solid #000000; vertical-align: middle; width: 10px;">YEAR</th>
            <th style="background-color: #0056b3; color: #ffffff; font-weight: bold; text-align: center; border: 1px solid #000000; vertical-align: middle; width: 15px;">AY</th>
            <th style="background-color: #0056b3; color: #ffffff; font-weight: bold; text-align: center; border: 1px solid #000000; vertical-align: middle; width: 15px;">SEM</th>
            
            {{-- 22-26. FINANCIAL & STATUS --}}
            <th style="background-color: #0056b3; color: #ffffff; font-weight: bold; text-align: center; border: 1px solid #000000; vertical-align: middle; width: 15px;">GRANT AMOUNT</th>
            <th style="background-color: #0056b3; color: #ffffff; font-weight: bold; text-align: center; border: 1px solid #000000; vertical-align: middle; width: 15px;">PAYMENT STATUS</th>
            <th style="background-color: #0056b3; color: #ffffff; font-weight: bold; text-align: center; border: 1px solid #000000; vertical-align: middle; width: 15px;">BILLING STATUS</th>
            <th style="background-color: #0056b3; color: #ffffff; font-weight: bold; text-align: center; border: 1px solid #000000; vertical-align: middle; width: 15px;">FILE</th>
            <th style="background-color: #0056b3; color: #ffffff; font-weight: bold; text-align: center; border: 1px solid #000000; vertical-align: middle; width: 25px;">COMPLIANCE</th>
        </tr>
    </thead>

    <tbody>
        @foreach($records as $record)
            @php
                $scholar = $record->enrollment?->scholar;
                $address = $scholar?->address;
                $hasFile = $scholar && $scholar->attachments && $scholar->attachments->isNotEmpty();
                $billingStatus = $record->billingRecord->status ?? 'Pending';
                $paymentStatus = $record->payment_status ?? 'Unpaid';
                
                // Compliance Logic
                $compliance = 'Incomplete';
                if ($billingStatus === 'Validated' && $hasFile) $compliance = 'Validated & Uploaded';
                elseif ($billingStatus === 'Validated') $compliance = 'Validated (No File)';
                elseif ($hasFile) $compliance = 'Pending (Uploaded)';
            @endphp
            <tr>
                <td style="text-align: center; border: 1px solid #000000; vertical-align: middle;">{{ $record->seq }}</td>
                
                <td style="border: 1px solid #000000; vertical-align: middle;">{{ $address?->region?->name ?? 'N/A' }}</td>
                <td style="border: 1px solid #000000; vertical-align: middle;">{{ $address?->province?->name ?? 'N/A' }}</td>
                <td style="border: 1px solid #000000; vertical-align: middle;">{{ $address?->city?->name ?? 'N/A' }}</td>
                <td style="border: 1px solid #000000; vertical-align: middle;">{{ $address?->district?->name ?? 'N/A' }}</td>
                <td style="border: 1px solid #000000; vertical-align: middle;">{{ $address?->barangay?->name ?? 'N/A' }}</td>
                <td style="text-align: center; border: 1px solid #000000; vertical-align: middle;">{{ $address?->zip_code }}</td>

                <td style="border: 1px solid #000000; vertical-align: middle;">{{ $record->hei?->hei_name }}</td>
                {{-- ✅ FIX: Correct HEI Type Accessor --}}
                <td style="text-align: center; border: 1px solid #000000; vertical-align: middle;">{{ $record->hei?->type_of_heis ?? $record->hei?->hei_type ?? 'N/A' }}</td>

                {{-- ✅ FIX: Correct Award/App No Accessor (via Enrollment) --}}
                <td style="text-align: center; border: 1px solid #000000; vertical-align: middle; font-family: monospace;">{{ $record->enrollment?->award_number }}</td>
                <td style="text-align: center; border: 1px solid #000000; vertical-align: middle; font-family: monospace;">{{ $record->enrollment?->application_number }}</td>

                {{-- ✅ FIX: Correct Name Accessor (via Enrollment -> Scholar) --}}
                <td style="border: 1px solid #000000; vertical-align: middle;">{{ $scholar?->family_name }}</td>
                <td style="border: 1px solid #000000; vertical-align: middle;">{{ $scholar?->given_name }}</td>
                <td style="border: 1px solid #000000; vertical-align: middle;">{{ $scholar?->extension_name }}</td>
                <td style="border: 1px solid #000000; vertical-align: middle;">{{ $scholar?->middle_name }}</td>
                <td style="text-align: center; border: 1px solid #000000; vertical-align: middle;">{{ $scholar?->sex }}</td>
                <td style="text-align: center; border: 1px solid #000000; vertical-align: middle;">{{ $scholar?->contact_no }}</td>

                <td style="border: 1px solid #000000; vertical-align: middle;">{{ $record->course?->course_name }}</td>
                <td style="text-align: center; border: 1px solid #000000; vertical-align: middle;">{{ $record->year_level }}</td>
                <td style="text-align: center; border: 1px solid #000000; vertical-align: middle;">{{ $record->academicYear?->name ?? $record->academic_year }}</td>
                <td style="text-align: center; border: 1px solid #000000; vertical-align: middle;">{{ $record->semester?->name ?? $record->semester }}</td>

                <td style="text-align: right; border: 1px solid #000000; vertical-align: middle;">{{ number_format($record->grant_amount, 2) }}</td>
                
                <td style="text-align: center; border: 1px solid #000000; vertical-align: middle; font-weight: bold; color: {{ $paymentStatus == 'Paid' ? '#008000' : '#FF0000' }}">
                    {{ $paymentStatus }}
                </td>
                
                <td style="text-align: center; border: 1px solid #000000; vertical-align: middle;">{{ $billingStatus }}</td>

                <td style="text-align: center; border: 1px solid #000000; vertical-align: middle; font-weight: bold; color: {{ $hasFile ? '#008000' : '#808080' }}">
                    {{ $hasFile ? 'YES' : 'NO' }}
                </td>
                <td style="text-align: center; border: 1px solid #000000; vertical-align: middle;">{{ $compliance }}</td>
            </tr>
        @endforeach
    </tbody>
</table>